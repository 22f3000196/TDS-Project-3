<!DOCTYPE html>
<html lang="en" style="font-size:18px">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="description" content="Querya - Advanced AI Assistant with Multi-Tool Capabilities, Voice Interface, and Real-time Collaboration" />
  <meta name="keywords" content="AI assistant, chat interface, web search, code execution, voice assistant" />
  <meta name="author" content="Gaurav Tomar" />
  <meta name="theme-color" content="#667eea" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Querya" />

  <link rel="manifest" href="manifest.json" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <title>Querya — Advanced AI Assistant</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- layout overrides: narrow header/composer, wider chat column, compact header -->
  <style>
    :root{
      --header-narrow-width: 980px;     /* header / title width */
      --composer-narrow-width: 980px;   /* input bar width */
      --chat-read-width: 1360px;        /* message column width */
    }

    /* keep input always visible & give messages room below it */
    .messages-container{padding-bottom:var(--input-height)}
    .input-area{position:sticky;bottom:0;z-index:100}

    /* compact header and create an inner centered row */
    .chat-header{padding:.75rem 0;border-bottom:1px solid var(--border-color)}
    .chat-header-inner{
      max-width: var(--header-narrow-width);
      margin: 0 auto;
      width: 100%;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
    }
    .chat-info h1{font-size:1.5rem;margin:0}
    .chat-info p{font-size:.85rem;opacity:.8;margin:0}

    /* wider reading column for chat messages */
    .messages{max-width:var(--chat-read-width)}

    /* narrower composer centered under chat */
    .input-container{
      max-width: var(--composer-narrow-width);
      margin: 0 auto;
      width: 100%;
    }

    /* welcome hero less tall */
    .welcome-screen{padding:1.25rem}
  </style>

  <script>
    if ('serviceWorker' in navigator) {
      addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>
</head>
<body>
  <!-- Loading -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="loading-logo"><i class="fas fa-brain fa-3x"></i></div>
      <h2>Querya</h2>
      <p>Initializing Advanced AI Assistant...</p>
      <div class="loading-bar"><div class="loading-progress"></div></div>
    </div>
  </div>

  <div id="app" class="app-container">
    <!-- Top nav (icons only) -->
    <nav class="top-nav">
      <div class="nav-brand">
        <i class="fas fa-brain"></i>
        <span class="brand-text">Querya</span>
        <!-- <span class="version-badge">v2.8.0</span> -->
      </div>
      <div class="nav-controls">
        <!-- <button id="voice-toggle" class="nav-btn" title="Voice"><i class="fas fa-microphone"></i></button> -->
        <button id="theme-toggle" class="nav-btn" title="Theme"><i class="fas fa-moon"></i></button>
        <button id="fullscreen-toggle" class="nav-btn" title="Fullscreen"><i class="fas fa-expand"></i></button>
        <button id="settings-toggle" class="nav-btn" title="Settings"><i class="fas fa-cog"></i></button>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <h3>Conversations</h3>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="new-chat" class="btn-new-chat" title="New Chat">
            <i class="fas fa-plus"></i><span class="sr-only">New chat</span>
          </button>
          <button id="delete-conversation" class="action-btn" title="Delete Current Conversation">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div id="conversation-list" class="conversation-list"></div>
      <div class="sidebar-footer">
        <div class="usage-stats">
          <div class="stat-item">
            <span class="stat-label">Messages</span>
            <span class="stat-value" id="total-messages">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Conversations</span>
            <span class="stat-value" id="total-conversations">0</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <header class="chat-header">
        <!-- NEW: inner wrapper so header is narrower -->
        <div class="chat-header-inner">
          <div class="chat-info">
            <h1 id="chat-title">Welcome to Querya</h1>
            <p id="chat-description">Created on <span id="chat-created"></span></p>
          </div>
          <div class="chat-actions">
            <button id="export-chat" class="action-btn" title="Export"><i class="fas fa-download"></i></button>
            <button id="share-chat" class="action-btn" title="Share"><i class="fas fa-share-nodes"></i></button>
            <button id="clear-chat" class="action-btn" title="Clear Messages"><i class="fas fa-eraser"></i></button>
            <button id="perf-open" class="action-btn" title="Performance Panel"><i class="fas fa-chart-line"></i></button>
          </div>
        </div>
      </header>

      <div id="messages-container" class="messages-container">
        <div id="welcome-screen" class="welcome-screen">
          <div class="welcome-content">
            <div class="welcome-icon"><i class="fas fa-robot fa-4x"></i></div>
            <h2>Welcome to Querya</h2>
            <p>Your intelligent AI assistant with advanced multi-tool capabilities</p>

            <div class="capability-grid">
              <div class="capability-card"><i class="fas fa-search"></i><h3>Smart Search</h3><p>Real-time web search</p></div>
              <div class="capability-card"><i class="fas fa-code"></i><h3>Code Execution</h3><p>Safe JS execution</p></div>
              <div class="capability-card"><i class="fas fa-brain"></i><h3>AI Workflows</h3><p>Data processing</p></div>
              <div class="capability-card"><i class="fas fa-microphone"></i><h3>Voice</h3><p>Hands-free commands</p></div>
            </div>

            <div class="quick-actions">
              <button class="quick-action" data-prompt="Help me research the latest AI developments"><i class="fas fa-flask"></i>Research AI Trends</button>
              <button class="quick-action" data-prompt="Create a data visualization showing sample sales data"><i class="fas fa-chart-bar"></i>Create Visualization</button>
              <button class="quick-action" data-prompt="Help me write and test a JavaScript function"><i class="fas fa-code"></i>Code Assistant</button>
            </div>
          </div>
        </div>

        <div id="messages" class="messages"></div>
      </div>

      <!-- Sticky composer (now narrower & centered) -->
      <div class="input-area" aria-label="Message input area">
        <div class="input-container">
          <div id="file-drop-zone" class="file-drop-zone">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drop files here to analyze</p>
          </div>

          <div class="input-wrapper">
            <button id="attach-file" class="input-btn" title="Attach file"><i class="fas fa-paperclip"></i></button>
            <textarea id="user-input" rows="1" maxlength="5000"
              placeholder="Type your message…  Enter to send, Shift+Enter for a new line"></textarea>
            <div class="input-actions">
              <button id="voice-input" class="input-btn voice-btn" title="Voice input"><i class="fas fa-microphone"></i></button>
              <button id="send-message" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
            </div>
          </div>

          <div class="input-footer">
            <div class="character-count"><span id="char-count">0</span>/5000</div>
            <div id="typing-indicator" class="typing-indicator">
              <div class="typing-dots"><span></span><span></span><span></span></div>
              <span class="typing-text">AI is thinking…</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" role="dialog" aria-hidden="true" aria-label="Settings">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" id="close-settings" aria-label="Close Settings"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <div class="settings-tabs">
          <button class="tab-btn active" data-tab="api">API</button>
          <button class="tab-btn" data-tab="ui">Interface</button>
          <button class="tab-btn" data-tab="voice">Voice</button>
          <button class="tab-btn" data-tab="advanced">Advanced</button>
        </div>

        <div id="api-tab" class="tab-content active">
          <div class="form-group">
            <label for="llm-provider">LLM Provider</label>
            <select id="llm-provider" class="form-control">
              <option value="aipipe">AI Pipe (aipipe.org)</option>
              <option value="openai">OpenAI GPT</option>
              <option value="anthropic">Anthropic Claude</option>
              <option value="google">Google Gemini</option>
              <option value="local">Local Model</option>
            </select>
          </div>

          <div class="form-group">
            <label for="api-key">API Key / Token</label>
            <div class="input-with-icon">
              <input type="password" id="api-key" class="form-control" placeholder="Enter your API key or AI Pipe token" />
              <button class="toggle-visibility" type="button" aria-label="Show/Hide API key"><i class="fas fa-eye"></i></button>
            </div>
          </div>

          <div class="form-group">
            <label for="model-name">Model</label>
            <select id="model-name" class="form-control"><option>Loading…</option></select>
          </div>

          <div class="form-group">
            <label for="max-tokens">Max tokens</label>
            <input id="max-tokens" type="number" class="form-control" value="2000" min="100" max="8000" />
          </div>

          <div class="form-group">
            <label for="temperature">Temperature</label>
            <input id="temperature" class="form-range" type="range" min="0" max="2" step="0.1" value="0.7" />
            <span class="range-value">0.7</span>
          </div>
        </div>

        <div id="ui-tab" class="tab-content">
          <div class="form-group">
            <label>Theme</label>
            <div class="radio-group">
              <label class="radio-label"><input type="radio" name="theme" value="auto" checked /><span>Auto</span></label>
              <label class="radio-label"><input type="radio" name="theme" value="light" /><span>Light</span></label>
              <label class="radio-label"><input type="radio" name="theme" value="dark" /><span>Dark</span></label>
            </div>
          </div>

          <div class="form-group"><label class="checkbox-label"><input id="animations-enabled" type="checkbox" checked /><span>Enable animations</span></label></div>
          <div class="form-group"><label class="checkbox-label"><input id="sound-enabled" type="checkbox" /><span>Sound effects</span></label></div>

          <div class="form-group">
            <label for="font-size">Font Size</label>
            <select id="font-size" class="form-control">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>

        <div id="voice-tab" class="tab-content">
          <div class="form-group"><label class="checkbox-label"><input id="voice-enabled" type="checkbox" /><span>Enable voice input</span></label></div>
          <div class="form-group"><label class="checkbox-label"><input id="voice-output-enabled" type="checkbox" /><span>Enable voice output</span></label></div>

          <div class="form-group">
            <label for="voice-language">Language</label>
            <select id="voice-language" class="form-control">
              <option value="en-US">English (US)</option>
              <option value="en-GB">English (UK)</option>
              <option value="es-ES">Spanish</option>
              <option value="fr-FR">French</option>
              <option value="de-DE">German</option>
            </select>
          </div>

          <div class="form-group">
            <label for="speech-rate">Speech rate</label>
            <input id="speech-rate" class="form-range" type="range" min="0.5" max="2" step="0.1" value="1" />
            <span class="range-value">1x</span>
          </div>
        </div>

        <div id="advanced-tab" class="tab-content">
          <div class="form-group"><label class="checkbox-label"><input id="auto-save" type="checkbox" checked /><span>Auto-save conversations</span></label></div>
          <div class="form-group"><label class="checkbox-label"><input id="analytics-enabled" type="checkbox" /><span>Enable analytics</span></label></div>
          <div class="form-group"><label for="max-history">Max conversation history</label><input id="max-history" class="form-control" type="number" value="100" min="10" max="1000" /></div>
          <div class="form-group"><button id="clear-all-data" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Clear All Data</button></div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="export-settings" class="btn btn-secondary"><i class="fas fa-download"></i> Export</button>
        <button id="import-settings" class="btn btn-secondary"><i class="fas fa-upload"></i> Import</button>
        <button id="save-settings" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- Performance monitor -->
  <div id="performance-monitor" class="performance-monitor">
    <div class="perf-header">
      <h4>Performance</h4>
      <button id="perf-close" class="perf-toggle" aria-label="Close"><i class="fas fa-times"></i></button>
    </div>
    <div class="perf-metrics">
      <div class="metric"><span class="metric-label">Response Time</span><span id="response-time" class="metric-value">0ms</span></div>
      <div class="metric"><span class="metric-label">Memory Usage</span><span id="memory-usage" class="metric-value">0MB</span></div>
      <div class="metric"><span class="metric-label">API Calls</span><span id="api-calls" class="metric-value">0</span></div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu">
    <div class="context-item" data-action="copy"><i class="fas fa-copy"></i> Copy</div>
    <div class="context-item" data-action="edit"><i class="fas fa-edit"></i> Edit</div>
    <div class="context-item" data-action="delete"><i class="fas fa-trash"></i> Delete</div>
    <div class="context-item" data-action="bookmark"><i class="fas fa-bookmark"></i> Bookmark</div>
  </div>

  <input id="file-input" type="file" multiple
         accept=".txt,.json,.csv,.md,.js,.py,.html,.css,.xml,.yaml,.yml,.sql,.log" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="agent.js"></script>

  <!-- helpers: share, perf open/close, better scroll, delete conversation -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.hljs && typeof hljs.highlightAll === 'function') hljs.highlightAll();

      const app = window.agentFlow;
      const createdEl = document.getElementById('chat-created');
      if (createdEl) createdEl.textContent = new Date().toLocaleDateString();

      // Share
      const shareBtn = document.getElementById('share-chat');
      shareBtn?.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopImmediatePropagation();
        try {
          const id = app?.state?.currentConversationId;
          const conv = id ? app.state.conversations.get(id) : null;
          if (!conv) return;
          const text = conv.messages.map(m=>{
            const who=({user:'You',assistant:'Querya',system:'System',tool:'Tool'})[m.role]||m.role;
            const body=typeof m.content==='string'?m.content:JSON.stringify(m.content);
            return `**${who}**:\n${body}`;
          }).join('\n\n');
          if (navigator.share) await navigator.share({title: conv.title||'Querya chat', text});
          else { await navigator.clipboard.writeText(text); app?.showToast?.('success','Copied','Chat copied to clipboard.'); }
        } catch(err){ app?.showToast?.('error','Share failed', err?.message||'Unable to share'); }
      }, true);

      // Perf open/close
      const perfPanel=document.getElementById('performance-monitor');
      document.getElementById('perf-open')?.addEventListener('click',()=>perfPanel?.classList.add('active'));
      document.getElementById('perf-close')?.addEventListener('click',()=>perfPanel?.classList.remove('active'));

      // Scroll to start of last message
      if (app) {
        app.scrollToBottom=function(){
          try{
            const c=this.elements.messagesContainer;
            const last=this.elements.messages?.lastElementChild;
            if(c&&last){ c.scrollTo({top:last.offsetTop-24,behavior:'smooth'}); }
          }catch(e){}
        };
      }

      // Delete current conversation
      document.getElementById('delete-conversation')?.addEventListener('click',()=>{
        try{
          const id=app?.state?.currentConversationId; if(!id) return;
          if(!confirm('Delete this conversation permanently?')) return;
          app.state.conversations.delete(id);
          const rest=Array.from(app.state.conversations.values()).sort((a,b)=>b.updatedAt-a.updatedAt)[0];
          if(rest) app.loadConversation(rest.id); else app.createNewConversation();
          app.saveCurrentConversation(); app.updateConversationList();
        }catch(e){ app?.showToast?.('error','Delete failed', e?.message||'Unknown error'); }
      });
    });
  </script>
</body>
</html>
